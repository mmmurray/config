#!/bin/bash
set -e

echo "Starting clean setup of MacOS..."

export CI=true

echo "Setting system preferences"

# Theme
defaults write -g AppleInterfaceStyle 'Dark'
defaults write -g AppleAccentColor -int 3
defaults write -g AppleAquaColorVariant -int 1
defaults write -g AppleHighlightColor '0.752941 0.964706 0.678431 Green'

# Keyboard and trackpad
defaults write com.apple.AppleMultitouchTrackpad Clicking -bool true
defaults write -g InitialKeyRepeat -int 15
defaults write -g KeyRepeat -int 2

# Finder preferences
defaults write -g AppleShowAllExtensions -bool true
defaults write com.apple.finder AppleShowAllFiles -bool true
defaults write com.apple.finder ShowPathbar -bool true
defaults write com.apple.finder ShowStatusBar -bool true
defaults write com.apple.finder FXEnableExtensionChangeWarning -bool false
defaults write com.apple.finder WarnOnEmptyTrash -bool false
defaults write com.apple.finder FXPreferredViewStyle 'clmv'
defaults write com.apple.finder _FXShowPosixPathInTitle -bool true

# Menubar
defaults write com.apple.menuextra.battery ShowPercent 'YES'
defaults write com.apple.menuextra.clock DateFormat 'EEE d MMM  HH:mm:ss'

# Dock
defaults write com.apple.dock autohide -bool true
defaults write com.apple.dock magnification -bool true
defaults write com.apple.dock show-recents -bool false
defaults write com.apple.dock tilesize -int 42
defaults write com.apple.dock largesize -int 74
defaults write com.apple.dock mru-spaces -bool false
defaults write com.apple.dock persistent-others -array
defaults write com.apple.dock persistent-apps -array '{
  "tile-data" = {
    book = <626f6f6b d4020000 00000410 30000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 f4010000 0c000000 01010000 4170706c 69636174 696f6e73 09000000 01010000 4e6f7465 732e6170 70000000 08000000 01060000 04000000 18000000 08000000 04030000 aa010000 00000000 08000000 04030000 e69b0000 00000000 08000000 01060000 3c000000 4c000000 08000000 00040000 41c11093 78000000 18000000 01020000 02000000 00000000 0f000000 00000000 00000000 00000000 08000000 01090000 66696c65 3a2f2f2f 0c000000 01010000 4d616369 6e746f73 68204844 08000000 04030000 0050f636 3a000000 08000000 00040000 41c1357a f74ab47b 24000000 01010000 45364345 34303938 2d433534 462d3442 46352d38 3741392d 33424446 30444636 46344233 18000000 01020000 81000000 01000000 ef130000 01000000 00000000 00000000 01000000 01010000 2f000000 00000000 01050000 ab000000 01020000 32366436 38333138 39353266 33323237 33623933 61343937 34386565 31356366 65663139 35303338 3b30303b 30303030 30303030 3b303030 30303030 303b3030 30303030 30303b30 30303030 30303030 30303030 3031613b 636f6d2e 6170706c 652e6170 702d7361 6e64626f 782e7265 61643b30 313b3031 30303030 30353b30 30303030 30303030 30303039 6265363b 30353b2f 6170706c 69636174 696f6e73 2f6e6f74 65732e61 70700000 a8000000 feffffff 01000000 00000000 0d000000 04100000 2c000000 00000000 05100000 5c000000 00000000 10100000 7c000000 00000000 40100000 6c000000 00000000 02200000 2c010000 00000000 05200000 9c000000 00000000 10200000 ac000000 00000000 11200000 e0000000 00000000 12200000 c0000000 00000000 13200000 d0000000 00000000 20200000 0c010000 00000000 30200000 38010000 00000000 81f00000 40010000 00000000>;
    "bundle-identifier" = "com.apple.Notes";
    "dock-extra" = 0;
    "file-data" =                 {
        "_CFURLString" = "file:///Applications/Notes.app/";
        "_CFURLStringType" = 15;
    };
    "file-label" = Notes;
    "file-type" = 41;
  };
  "tile-type" = "file-tile";
}' '{
  "tile-data" = {
    book = <626f6f6b ec020000 00000410 30000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 0c020000 0c000000 01010000 4170706c 69636174 696f6e73 11000000 01010000 476f6f67 6c652043 68726f6d 652e6170 70000000 08000000 01060000 04000000 18000000 08000000 04030000 aa010000 00000000 08000000 04030000 ac930b00 00000000 08000000 01060000 44000000 54000000 08000000 00040000 41c12ab6 45000000 18000000 01020000 02000000 00000000 0f000000 00000000 00000000 00000000 08000000 01090000 66696c65 3a2f2f2f 0c000000 01010000 4d616369 6e746f73 68204844 08000000 04030000 0050f636 3a000000 08000000 00040000 41c1357a f74ab47b 24000000 01010000 45364345 34303938 2d433534 462d3442 46352d38 3741392d 33424446 30444636 46344233 18000000 01020000 81000000 01000000 ef130000 01000000 00000000 00000000 01000000 01010000 2f000000 00000000 01050000 b9000000 01020000 31633435 31346265 33313566 39303037 63373438 62313534 62316634 33643562 65636334 35633530 3b30303b 30303030 30303030 3b303030 30303030 303b3030 30303030 30303b30 30303030 30303030 30303030 3032303b 636f6d2e 6170706c 652e6170 702d7361 6e64626f 782e7265 61642d77 72697465 3b30313b 30313030 30303035 3b303030 30303030 30303030 62393361 633b3031 3b2f6170 706c6963 6174696f 6e732f67 6f6f676c 65206368 726f6d65 2e617070 00000000 a8000000 feffffff 01000000 00000000 0d000000 04100000 34000000 00000000 05100000 64000000 00000000 10100000 84000000 00000000 40100000 74000000 00000000 02200000 34010000 00000000 05200000 a4000000 00000000 10200000 b4000000 00000000 11200000 e8000000 00000000 12200000 c8000000 00000000 13200000 d8000000 00000000 20200000 14010000 00000000 30200000 40010000 00000000 80f00000 48010000 00000000>;
    "bundle-identifier" = "com.google.Chrome";
    "dock-extra" = 0;
    "file-data" =                 {
        "_CFURLString" = "file:///Applications/Google%20Chrome.app/";
        "_CFURLStringType" = 15;
    };
    "file-label" = "Google Chrome";
    "file-type" = 41;
  };
  "tile-type" = "file-tile";
}' '{
  "tile-data" = {
    book = <626f6f6b 80030000 00000410 30000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 7c020000 05000000 01010000 55736572 73000000 0a000000 01010000 6d61726b 6d757272 61790000 0c000000 01010000 4170706c 69636174 696f6e73 09000000 01010000 69546572 6d2e6170 70000000 10000000 01060000 04000000 14000000 28000000 3c000000 08000000 04030000 53b80a00 00000000 08000000 04030000 74610b00 00000000 08000000 04030000 049e0b00 00000000 08000000 04030000 e7451400 00000000 10000000 01060000 68000000 78000000 88000000 98000000 08000000 00040000 41c1233f 43000000 18000000 01020000 02000000 00000000 0f000000 00000000 00000000 00000000 08000000 04030000 02000000 00000000 04000000 03030000 f5010000 08000000 01090000 66696c65 3a2f2f2f 0c000000 01010000 4d616369 6e746f73 68204844 08000000 04030000 0050f636 3a000000 08000000 00040000 41c1357a f74ab47b 24000000 01010000 45364345 34303938 2d433534 462d3442 46352d38 3741392d 33424446 30444636 46344233 18000000 01020000 81000000 01000000 ef130000 01000000 00000000 00000000 01000000 01010000 2f000000 00000000 01050000 c2000000 01020000 33323034 35643932 31333364 66613035 33613231 62386433 36323134 61633863 39613834 66326433 3b30303b 30303030 30303030 3b303030 30303030 303b3030 30303030 30303b30 30303030 30303030 30303030 3032303b 636f6d2e 6170706c 652e6170 702d7361 6e64626f 782e7265 61642d77 72697465 3b30313b 30313030 30303035 3b303030 30303030 30303031 34343565 373b3031 3b2f7573 6572732f 6d61726b 6d757272 61792f61 70706c69 63617469 6f6e732f 69746572 6d2e6170 70000000 cc000000 feffffff 01000000 00000000 10000000 04100000 50000000 00000000 05100000 a8000000 00000000 10100000 d0000000 00000000 40100000 c0000000 00000000 02200000 9c010000 00000000 05200000 0c010000 00000000 10200000 1c010000 00000000 11200000 50010000 00000000 12200000 30010000 00000000 13200000 40010000 00000000 20200000 7c010000 00000000 30200000 a8010000 00000000 01c00000 f0000000 00000000 11c00000 14000000 00000000 12c00000 00010000 00000000 80f00000 b0010000 00000000>;
    "bundle-identifier" = "com.googlecode.iterm2";
    "dock-extra" = 0;
    "file-data" =                 {
        "_CFURLString" = "file:///Applications/iTerm.app/";
        "_CFURLStringType" = 15;
    };
    "file-label" = iTerm;
    "file-type" = 41;
  };
  "tile-type" = "file-tile";
}' '{
  "tile-data" = {
    book = <626f6f6b f4020000 00000410 30000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 14020000 0c000000 01010000 4170706c 69636174 696f6e73 16000000 01010000 56697375 616c2053 74756469 6f20436f 64652e61 70700000 08000000 01060000 04000000 18000000 08000000 04030000 aa010000 00000000 08000000 04030000 71dd2500 00000000 08000000 01060000 48000000 58000000 08000000 00040000 41c127a8 2d000000 18000000 01020000 02000000 00000000 0f000000 00000000 00000000 00000000 08000000 01090000 66696c65 3a2f2f2f 0c000000 01010000 4d616369 6e746f73 68204844 08000000 04030000 0050f636 3a000000 08000000 00040000 41c1357a f74ab47b 24000000 01010000 45364345 34303938 2d433534 462d3442 46352d38 3741392d 33424446 30444636 46344233 18000000 01020000 81000000 01000000 ef130000 01000000 00000000 00000000 01000000 01010000 2f000000 00000000 01050000 be000000 01020000 30313437 31643236 38613830 39633836 30643466 38393165 36656534 33323535 30346431 38313432 3b30303b 30303030 30303030 3b303030 30303030 303b3030 30303030 30303b30 30303030 30303030 30303030 3032303b 636f6d2e 6170706c 652e6170 702d7361 6e64626f 782e7265 61642d77 72697465 3b30313b 30313030 30303035 3b303030 30303030 30303032 35646437 313b3031 3b2f6170 706c6963 6174696f 6e732f76 69737561 6c207374 7564696f 20636f64 652e6170 70000000 a8000000 feffffff 01000000 00000000 0d000000 04100000 38000000 00000000 05100000 68000000 00000000 10100000 88000000 00000000 40100000 78000000 00000000 02200000 38010000 00000000 05200000 a8000000 00000000 10200000 b8000000 00000000 11200000 ec000000 00000000 12200000 cc000000 00000000 13200000 dc000000 00000000 20200000 18010000 00000000 30200000 44010000 00000000 80f00000 4c010000 00000000>;
    "bundle-identifier" = "com.microsoft.VSCode";
    "dock-extra" = 0;
    "file-data" =                 {
        "_CFURLString" = "file:///Applications/Visual%20Studio%20Code.app/";
        "_CFURLStringType" = 15;
    };
    "file-label" = "Visual Studio Code";
    "file-type" = 41;
  };
  "tile-type" = "file-tile";
}' '{
  "tile-data" = {
    book = <626f6f6b dc020000 00000410 30000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 fc010000 0c000000 01010000 4170706c 69636174 696f6e73 09000000 01010000 58636f64 652e6170 70000000 08000000 01060000 04000000 18000000 08000000 04030000 aa010000 00000000 08000000 04030000 f5d50b00 00000000 08000000 01060000 3c000000 4c000000 08000000 00040000 41c12b76 62800000 18000000 01020000 02000000 00000000 0f000000 00000000 00000000 00000000 08000000 01090000 66696c65 3a2f2f2f 0c000000 01010000 4d616369 6e746f73 68204844 08000000 04030000 0050f636 3a000000 08000000 00040000 41c1357a f74ab47b 24000000 01010000 45364345 34303938 2d433534 462d3442 46352d38 3741392d 33424446 30444636 46344233 18000000 01020000 81000000 01000000 ef130000 01000000 00000000 00000000 01000000 01010000 2f000000 00000000 01050000 b1000000 01020000 64366161 35366361 34313835 38313261 64613165 37333330 39366434 30623762 36663236 30383266 3b30303b 30303030 30303030 3b303030 30303030 303b3030 30303030 30303b30 30303030 30303030 30303030 3032303b 636f6d2e 6170706c 652e6170 702d7361 6e64626f 782e7265 61642d77 72697465 3b30313b 30313030 30303037 3b303030 30303030 30303030 62643566 353b3031 3b2f6170 706c6963 6174696f 6e732f78 636f6465 2e617070 00000000 a8000000 feffffff 01000000 00000000 0d000000 04100000 2c000000 00000000 05100000 5c000000 00000000 10100000 7c000000 00000000 40100000 6c000000 00000000 02200000 2c010000 00000000 05200000 9c000000 00000000 10200000 ac000000 00000000 11200000 e0000000 00000000 12200000 c0000000 00000000 13200000 d0000000 00000000 20200000 0c010000 00000000 30200000 38010000 00000000 80f00000 40010000 00000000>;
    "bundle-identifier" = "com.apple.dt.Xcode";
    "dock-extra" = 0;
    "file-data" =                 {
        "_CFURLString" = "file:///Applications/Xcode.app/";
        "_CFURLStringType" = 15;
    };
    "file-label" = Xcode;
    "file-type" = 41;
  };
  "tile-type" = "file-tile";
}' '{
  "tile-data" = {
    book = <626f6f6b ec020000 00000410 30000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 0c020000 0c000000 01010000 4170706c 69636174 696f6e73 16000000 01010000 53797374 656d2050 72656665 72656e63 65732e61 70700000 08000000 01060000 04000000 18000000 08000000 04030000 aa010000 00000000 08000000 04030000 e9160100 00000000 08000000 01060000 48000000 58000000 08000000 00040000 41c11cfe 47800000 18000000 01020000 02000000 00000000 0f000000 00000000 00000000 00000000 08000000 01090000 66696c65 3a2f2f2f 0c000000 01010000 4d616369 6e746f73 68204844 08000000 04030000 0050f636 3a000000 08000000 00040000 41c1357a f74ab47b 24000000 01010000 45364345 34303938 2d433534 462d3442 46352d38 3741392d 33424446 30444636 46344233 18000000 01020000 81000000 01000000 ef130000 01000000 00000000 00000000 01000000 01010000 2f000000 00000000 01050000 b8000000 01020000 34623863 39333430 33373733 65343936 66306630 63353730 33653838 30626430 64613033 31356561 3b30303b 30303030 30303030 3b303030 30303030 303b3030 30303030 30303b30 30303030 30303030 30303030 3031613b 636f6d2e 6170706c 652e6170 702d7361 6e64626f 782e7265 61643b30 313b3031 30303030 30373b30 30303030 30303030 30303131 3665393b 30353b2f 6170706c 69636174 696f6e73 2f737973 74656d20 70726566 6572656e 6365732e 61707000 a8000000 feffffff 01000000 00000000 0d000000 04100000 38000000 00000000 05100000 68000000 00000000 10100000 88000000 00000000 40100000 78000000 00000000 02200000 38010000 00000000 05200000 a8000000 00000000 10200000 b8000000 00000000 11200000 ec000000 00000000 12200000 cc000000 00000000 13200000 dc000000 00000000 20200000 18010000 00000000 30200000 44010000 00000000 81f00000 4c010000 00000000>;
    "bundle-identifier" = "com.apple.systempreferences";
    "dock-extra" = 1;
    "file-data" =                 {
        "_CFURLString" = "file:///Applications/System%20Preferences.app/";
        "_CFURLStringType" = 15;
    };
    "file-label" = "System Preferences";
    "file-type" = 1;
  };
  "tile-type" = "file-tile";
}'

echo "Installing Homebrew"
/usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"

echo "Installing Google Chrome"
brew cask install google-chrome
open "/Applications/Google Chrome.app" --args --make-default-browser

echo "Configuring Git"
git config --global user.email "mark@murray.xyz"
git config --global user.name "Mark Murray"
ssh-keygen -t rsa -b 4096 -C "mark@murray.xyz" -f ~/.ssh/id_rsa -P ""
cat ~/.ssh/id_rsa.pub | pbcopy
echo "SSH key generated and copied to clipboard. Add to https://github.com/settings/keys"

echo "Installing Visual Studio Code"
brew cask install visual-studio-code

echo "Installing iTerm2"
brew cask install iterm2

echo "Installing Spotify"
brew cask install spotify

echo "Installing Docker"
brew cask install docker

echo "Installing Postman"
brew cask install postman

echo "Installing BetterTouchTool"
brew cask install bettertouchtool

echo "Installing hub"
brew install hub

echo "Installing Node"
brew install node

echo "Installing Yarn"
npm i -g yarn

echo "Cloning projects"
mkdir ~/projects
cd ~/projects
hub clone config

echo "Installing ZSH"
sh -c "$(curl -fsSL https://raw.github.com/robbyrussell/oh-my-zsh/master/tools/install.sh)"
cat "source ~/projects/config/shell/.profile" >> ~/.zshrc

echo "Automatic install complete. Manual setup tasks:"
echo "  1. System Preferences > Security & Privacy > General"
echo "     - Require password 'immediately' after sleep of screensaver begins"
echo "     - Allow Apple Watch to unlock your Mac"
echo "  2. Open BetterTouchTool"
echo "     - Import license from Google Drive"
echo "     - Import defaults from https://github.com/mmmurray/config/blob/master/better-touch-tool/mmm.bttpreset"
echo "  3. Open Visual Studio Code"
echo "     - Install 'code' command in PATH"
echo "     - code --install-extension Shan.code-settings-sync"
echo "     - Download settings: Shift + Option + D (https://gist.github.com/mmmurray)"
echo "  4. Install Xcode from the App Store"
echo "  5. Sign in to Google Chrome"
echo "  6. Set Google Chrome as the default browser (CMD + , to open preferences)"
echo "  7. Sign in to Spotify"
